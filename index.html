<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>VisionHealth – Captura</title>
<style>
  :root{ --bg:#eaf3ff; --ink:#0c2a63; --ink2:#1d3e8a; --card:#ffffff; --muted:#6b7280; }
  *{ box-sizing:border-box }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--ink);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif }
  .wrap{ min-height:100svh; display:flex; align-items:center; justify-content:center;
    padding:calc(env(safe-area-inset-top,0px) + 12px) 12px calc(env(safe-area-inset-bottom,0px) + 12px) }
  .phone{ width:min(440px,100%); border-radius:24px; box-shadow:0 12px 32px rgba(0,0,0,.12);
    background:linear-gradient(#eaf3ff,#dfeefe); overflow:hidden; }
  .top{ padding:12px 14px 8px; text-align:center; text-shadow:0 1px 0 rgba(255,255,255,.7) }
  .t1{ font-weight:800; font-size:20px; line-height:1.2 }
  .t2{ font-weight:700; font-size:16px }
  .videoBox{ position:relative; margin:8px 12px; border-radius:16px; overflow:hidden; background:#cfe1ff; }
  video{ display:block; width:100%; height:64svh; max-height:62vh; object-fit:cover; background:#cfe1ff; }
  .aim{ pointer-events:none; position:absolute; inset:0; display:grid; place-items:center }
  .outer{ width:min(70%, 340px); aspect-ratio:1/1; border-radius:50%; outline:3px solid rgba(12,42,99,.9); outline-offset:-3px }
  .inner{ position:absolute; width:min(38%, 180px); aspect-ratio:1/1; border:3px dashed rgba(12,42,99,.7); border-radius:50% }
  .controls{ display:flex; gap:10px; padding:10px 12px 14px; align-items:center; justify-content:space-between }
  .btn{ height:44px; padding:0 14px; border-radius:12px; border:2px solid var(--ink2); background:var(--ink2); color:#fff; font-weight:700; cursor:pointer }
  .btn.secondary{ background:#fff; color:var(--ink2) }
  .btn:disabled{ opacity:.5; cursor:not-allowed }
  .row{ display:flex; gap:10px }
  .toast{ text-align:center; padding:8px 12px; font-size:13px; color:#fff; background:#111827; margin:8px 12px 14px; border-radius:10px; display:none }
  canvas{ display:block; width:100%; max-height:60vh; background:#000 }
  .hidden{ display:none }
</style>
</head>
<body>
  <div class="wrap">
    <div class="phone">
      <div class="top">
        <div class="t1">Aproxime o olho até preencher o círculo</div>
        <div class="t2">Mantenha-se estável e olhe para o ponto</div>
      </div>

      <div class="videoBox">
        <video id="video" playsinline autoplay muted></video>
        <div class="aim">
          <div class="outer"></div>
          <div class="inner"></div>
        </div>
      </div>

      <div class="controls">
        <div class="row">
          <button id="start" class="btn">Ativar câmera</button>
          <button id="flip" class="btn secondary" disabled>Alternar câmera</button>
        </div>
        <div class="row">
          <button id="capture" class="btn secondary" disabled>Capturar</button>
          <a id="download" class="btn hidden" download="captura-visionhealth.jpg">Baixar</a>
        </div>
      </div>

      <div id="toast" class="toast"></div>
      <canvas id="photo" class="hidden"></canvas>
    </div>
  </div>

<script>
(() => {
  const video = document.getElementById('video');
  const startBtn = document.getElementById('start');
  const flipBtn = document.getElementById('flip');
  const capBtn = document.getElementById('capture');
  const dl = document.getElementById('download');
  const canvas = document.getElementById('photo');
  const toast = document.getElementById('toast');

  let stream = null;
  let devices = [];
  let currentIndex = 0;

  const show = (msg, ms=2500) => {
    toast.textContent = msg; toast.style.display='block';
    setTimeout(()=> toast.style.display='none', ms);
  };

  const isSecure = () => (location.protocol === 'https:' || location.hostname === 'localhost');

  async function getCameras(){
    const all = await navigator.mediaDevices.enumerateDevices();
    devices = all.filter(d => d.kind === 'videoinput');
    flipBtn.disabled = devices.length < 2;
  }

  async function start(constraints){
    // Para iOS: precisa ser chamado por clique e usar playsInline+muted+play()
    stream = await navigator.mediaDevices.getUserMedia({ video: constraints, audio:false });
    video.srcObject = stream;
    video.muted = true;
    video.playsInline = true;
    await video.play();
    capBtn.disabled = false;
    await getCameras();

    // guarda índice do device atual
    const track = stream.getVideoTracks()[0];
    const id = track.getSettings().deviceId;
    currentIndex = Math.max(0, devices.findIndex(d => d.deviceId === id));
  }

  async function startBest(){
    if(!isSecure()){ show('Abra via HTTPS (ou http://localhost).'); return; }
    try{
      // tenta traseira
      await start({ facingMode: { exact:'environment' }, width:{ideal:1280}, height:{ideal:720} });
    }catch(_){
      // cai para frontal
      try{
        await start({ facingMode: { ideal:'user' }, width:{ideal:1280}, height:{ideal:720} });
      }catch(err){
        console.error(err);
        if(err.name === 'NotAllowedError') show('Permissão negada. Autorize a câmera nas configurações do navegador.');
        else if(err.name === 'NotFoundError') show('Nenhuma câmera disponível.');
        else if(err.name === 'NotReadableError') show('Câmera ocupada por outro app.');
        else show('Falha ao iniciar a câmera.');
        return;
      }
    }
    startBtn.disabled = true;
    show('Câmera ativa.');
  }

  async function flip(){
    if(devices.length < 2) return;
    currentIndex = (currentIndex + 1) % devices.length;
    const devId = devices[currentIndex].deviceId;
    await stop();
    await start({ deviceId:{ exact: devId } });
  }

  async function stop(){
    if(stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
  }

  function capture(){
    if(!stream){ show('Ative a câmera primeiro.'); return; }
    const w = video.videoWidth || 1280;
    const h = video.videoHeight || 720;
    const s = Math.min(w, h);
    const sx = (w - s)/2, sy = (h - s)/2;
    canvas.width = s; canvas.height = s;
    const ctx = canvas.getContext('2d');
    // espelha para combinar com o preview (selfie). Se quiser sem espelho, remova translate/scale.
    ctx.save(); ctx.translate(s,0); ctx.scale(-1,1);
    ctx.drawImage(video, sx, sy, s, s, 0, 0, s, s);
    ctx.restore();
    const data = canvas.toDataURL('image/jpeg', .92);
    dl.href = data;
    dl.classList.remove('hidden');
    show('Foto capturada. Toque em Baixar.');
  }

  // eventos
  startBtn.addEventListener('click', startBest);
  flipBtn.addEventListener('click', flip);
  capBtn.addEventListener('click', capture);

  // mensagens úteis ao carregar
  if(!('mediaDevices' in navigator)) show('Este navegador não suporta getUserMedia.');
  else if(!isSecure()) show('Dica: em celular, só funciona em HTTPS (ou localhost).');

  // se trocar câmera no SO, atualizamos lista
  navigator.mediaDevices.addEventListener?.('devicechange', getCameras);
})();
</script>
</body>
</html>
